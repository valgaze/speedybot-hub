//@ts-nocheck
// This is LOOSE (no types), copy & paste and you're off 🚀
/**
 * Welcome to your Speedybot-Hub!
 * ╔═╗ ╔═╗ ╔═╗ ╔═╗ ╔╦╗ ╦ ╦ ╔╗  ╔═╗ ╔╦╗
 * ╚═╗ ╠═╝ ║╣  ║╣   ║║ ╚╦╝ ╠╩╗ ║ ║  ║
 * ╚═╝ ╩   ╚═╝ ╚═╝ ═╩╝  ╩  ╚═╝ ╚═╝  ╩ HUB
 *
 * 1. Add your WebEx bot token to the token field below
 * 2. Sign up for a cloudflare account & note the URL
 * 3. Register your webhooks (it won't work without it)
 * 4. Copy and paste this WHOLE file into your Worker & press Save & Deploy
 * 5. Register your webhooks
 * $ npm init speedybot webhook create -- -t __replace_token_here -w https://speedybot-hub.yourusername.workers.dev
 *
 * Instructions: https://github.com/valgaze/speedybot-hub/blob/master/quickstart.md
 */

// 1) Add bot token here: https://developer.webex.com/my-apps/new
const config = {
    token: '__REPLACE__ME__',
}

// 2) Add handlers
const handlers = [
  {
    keyword: "hi",
    handler($bot) {
      $bot.send('Hi there!')
      $bot.send(
        $bot.card({
          title: `Select a 'chip' below`,
          chips: [
            "Ping",
            {
              keyword: "Pong",
              label: `Say 'Pong'`,
            },
            "files",
            {
              keyword: "sendcard",
              label: "card",
            },
            "hi",
          ],
        })
      );
    },
  },
];

// Speedybot-hub, https://github.com/valgaze/speedybot-hub
var x=class{constructor(){this.title="",this.subtitle="",this.titleConfig={},this.subTitleConfig={},this.choices=[],this.choiceConfig={},this.image="",this.imageConfig={},this.buttonLabel="Submit",this.inputPlaceholder="",this.inputConfig={id:"inputData"},this.url="",this.urlLabel="Go",this.tableData=[],this.attachedData={},this.needsSubmit=!1,this.dateData={},this.timeData={},this.json={$schema:"http://adaptivecards.io/schemas/adaptive-card.json",type:"AdaptiveCard",version:"1.0",body:[]}}setTitle(b,a){return this.title=b,a&&(this.titleConfig=a),this}setSubtitle(b,a){return this.subtitle=b,a&&(this.subTitleConfig=a),this}setChoices(b,a){return this.choices=b.map((a,b)=>({title:a,value:a})),a&&(this.choiceConfig=a),this}setImage(b,a){return this.image=b,a&&(this.imageConfig=a),this}setButtonLabel(a){return this.buttonLabel=a,this}setInput(b,a){return this.inputPlaceholder=b,a&&(this.inputConfig=a),this}setUrl(a,b="Go"){return this.urlLabel=b,this.url=a,this}setUrlLabel(a){return this.urlLabel=a,this}setTable(a){let b=a;return Array.isArray(a)||"object"!=typeof a||(b=Object.entries(a)),this.tableData=b,this}setData(a){return a&&(this.attachedData=a,this.needsSubmit=!0),this}setDate(a="selectedDate",b="Select a date"){return this.dateData={type:"Input.Date",id:a,label:b},this}setTime(a="selectedTime",b="Select a time"){return this.timeData={type:"Input.Time",id:a,label:b},this}setChips(b){let a=b.map(a=>{let b="",c="";if("string"==typeof a)b=a,c=a;else{let{label:d,keyword:e=""}=a;b=d,c=e||d}return{type:"Action.Submit",title:b,data:{chip_action:c}}});return this.json.actions=this.json.actions?this.json.actions.push(a):a,this}render(){if(this.title){let i={type:"TextBlock",text:this.title,weight:"Bolder",size:"Large",wrap:!0,...this.titleConfig};this.json.body.push(i)}if(this.subtitle){let l={type:"TextBlock",text:this.subtitle,size:"Medium",isSubtle:!0,wrap:!0,weight:"Lighter",...this.subTitleConfig};this.json.body.push(l)}if(this.tableData&&this.tableData.length){let m={type:"FactSet",facts:[]};this.tableData.forEach(([a,b],d)=>{let c={title:a,value:b};m.facts.push(c)}),this.json.body.push(m)}if(this.image){let n={type:"Image",url:this.image,horizontalAlignment:"Center",size:"Large",...this.imageConfig};this.json.body.push(n)}if(this.choices.length){this.needsSubmit=!0;let o={type:"Input.ChoiceSet",id:"choiceSelect",value:"0",isMultiSelect:!1,isVisible:!0,choices:this.choices,...this.choiceConfig};this.json.body.push(o)}if(this.inputPlaceholder){this.needsSubmit=!0;let p={type:"Input.Text",placeholder:this.inputPlaceholder,...this.inputConfig};this.json.body.push(p)}if(Object.keys(this.dateData).length){let{id:b,type:c,label:d}=this.dateData;d&&this.json.body.push({type:"TextBlock",text:d,wrap:!0}),b&&c&&this.json.body.push({id:b,type:c}),this.needsSubmit=!0}if(Object.keys(this.timeData).length){let{id:e,type:f,label:g}=this.timeData;g&&this.json.body.push({type:"TextBlock",text:g,wrap:!0}),e&&f&&this.json.body.push({id:e,type:f}),this.needsSubmit=!0}if(this.needsSubmit){let a={type:"Action.Submit",title:this.buttonLabel};this.attachedData&&(a.data=this.attachedData),this.json.actions?.length?this.json.actions.push(a):this.json.actions=[a]}else this.attachedData&&Object.keys(this.attachedData).length&&console.log("attachedData ignore, you must call at least either .setInput(), .setChoices, .setDate, .setTime, to pass through data with an adaptive card");if(this.url){let h={type:"Action.OpenUrl",title:this.urlLabel,url:this.url};this.json.actions?this.json.actions.push(h):this.json.actions=[h]}return this.json}renderFull(){return{roomId:"__REPLACE__ME__",markdown:"Fallback text **here**",attachments:[this.render()]}}},C={getMessageDetails:"https://webexapis.com/v1/messages",getAttachmentDetails:"https://webexapis.com/v1/attachment/actions",getMembershipDetails:"https://webexapis.com/v1/memberships",getPersonDetails:"https://webexapis.com/v1/people",sendMessage:"https://webexapis.com/v1/messages",createWebhook:"https://webexapis.com/v1/webhooks",deleteWebhook:"https://webexapis.com/v1/webhooks",getWebhooks:"https://webexapis.com/v1/webhooks",getSelf:"https://webexapis.com/v1/people/me",deleteMessage:"https://webexapis.com/v1/messages"},j="__REPLACE__ME__",B=a=>{let b=null;if("messages"===a.resource){if("files"in a.data&&a.data.files?.length){let{files:c=[]}=a.data;c&&c.length&&(b="FILE")}else b="TEXT"}return"attachmentActions"===a.resource&&(b="AA"),"memberships"===a.resource&&("deleted"===a.event&&(b="MEMBERSHIP:REMOVE"),"created"===a.event&&(b="MEMBERSHIP:ADD")),b},k={isSpeedyCard:a=>"object"==typeof a&&"render"in a&&"function"==typeof a.render,isCard(b){if(this.isSpeedyCard(b))return!0;let a=JSON.stringify(b);return a.includes("AdaptiveCard")&&a.includes("$schema")&&a.includes("version")},isEmail:a=>a.includes("@")&&a.includes(".")},P=async(e,b,a={})=>{let c={method:"POST","content-type":"application/json;charset=UTF-8",raw:!1},f=a["content-type"]?a["content-type"]:c["content-type"],g=a.headers?a.headers:{},d={method:a.method?a.method:c.method,headers:{"content-type":f,Authorization:`Bearer ${a.token}`,...g}};return"POST"===a.method&&(d.body=a.raw?b:JSON.stringify(b)),await fetch(e,d)},A=(a=[])=>a[Math.floor(Math.random()*a.length)],_=(b,c)=>{let a;a="string"!=typeof b?A(b)||"":b;let e=(a,b,c)=>a.includes(`$[${b}]`)?e(a.replace(`$[${b}]`,c),b,c):a;for(let d in c){let f=c[d];a=e(a,d,f)}return a},L=async(e,b,c,d)=>{let{pathname:f}=new URL(b.url);if(f in e){let a=e[f];if("function"==typeof a)return a(b,c,d)||w();if("handler"in a&&"function"==typeof a.handler){if("method"in a){let{method:g=""}=a;if(g.toLowerCase()!==b.method.toLowerCase())return new Response(`Expected method '${g}' rather than '${b.method}'`,{status:400})}if("validate"in a&&"function"==typeof a.validate){let{proceed:h}=await a.validate(b,c,d);return h?a.handler(b,c,d):new Response("Validation failed",{status:400})}return a.handler(b,c,d)||w()}}return w()},O=a=>new Response(a,{status:200,headers:{"content-type":"text/html;charset=UTF-8"}}),w=()=>new Response(`
Server(less) Time: ${new Date().toString()}
*
* \u2554\u2550\u2557 \u2554\u2550\u2557 \u2554\u2550\u2557 \u2554\u2550\u2557 \u2554\u2566\u2557 \u2566 \u2566 \u2554\u2557  \u2554\u2550\u2557 \u2554\u2566\u2557
* \u255A\u2550\u2557 \u2560\u2550\u255D \u2551\u2563  \u2551\u2563   \u2551\u2551 \u255A\u2566\u255D \u2560\u2569\u2557 \u2551 \u2551  \u2551
* \u255A\u2550\u255D \u2569   \u255A\u2550\u255D \u255A\u2550\u255D \u2550\u2569\u255D  \u2569  \u255A\u2550\u255D \u255A\u2550\u255D  \u2569 HUB
*
* Setup Instructions (make your own bot): https://github.com/valgaze/speedybot-hub
* `,{status:200}),q=`<script src="https://code.s4d.io/widget-space/production/bundle.js"></script><link rel="stylesheet" href="https://code.s4d.io/widget-space/production/main.css"><link rel="stylesheet" href="https://code.s4d.io/widget-recents/production/main.css"><script src="https://code.s4d.io/widget-recents/production/bundle.js"></script><style>input{cursor: pointer; color: #34495e; font-size: 1rem; line-height: 1.4rem; width: 100%; font-family: 'Courier New'; margin: 6px; background: #ecf0f1;}*{font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; font-size: 14px; color: #34495e;}body{background-color: #ecf0f1;}.launch-button{background: #2ecc71; padding: 1%; color: #fff; font-weight: 900; font-family: sans-serif; border: none; border-radius: 14px; cursor: pointer;}.launch-button:hover{background: #41d47f;}.launch-wrap{padding: 1%;}</style><body> <div class="chat-wrap"> <fieldset> <legend>WebEx in a Web Embed</legend> <div> <label>\u{1F446}Stable Source available <b><a href="https://github.com/valgaze/speedybot/blob/master/docs/webex.html" target="_blank">here</a></b>) </label> <br/> <label>Set access id (copy access token from <a href="https://developer.webex.com/my-apps" target="_blank">here</a>): </label> <input type="text" id="access_id_input" value="" placeholder="access id here"/> </div><button id="launch" class="launch-button">LAUNCH</button> </fieldset> <div class="launch-wrap"> <div style="display: flex; justify-content: center;"> <div id="webex-recent" style="width: 500px; height: 500px;"></div><div id="webex-space" style="width: 500px; height: 500px; background: radial-gradient(#e74c3c, transparent); display:flex; justify-content: center;"> <div> <h3>Select a 1-1 conversation from the left </h3> <div>Note: Bots can only request mentions, not whole conversations</div></div></div></div></div><fieldset> <legend>Send Rich Card</legend> <div class="form-group"> <label class="col-md-4 control-label" for="card_title">Title</label> <div class="col-md-4"> <input id="card_title" name="card_title" type="text"/> </div></div><div class="form-group"> <label for="card_subtitle">Subtitle</label> <div> <input id="card_subtitle" name="card_subtitle" type="text"/> </div></div><div class="form-group"> <label class="control-label" for="image_url">Image URL</label> <div> <input id="image_url" name="image_url" type="text"/> </div></div><button id="send_card" class="launch-button">Send Card</button> </fieldset> </div><script>let targetRoom=null; const urlParams=new URLSearchParams(window.location.search); const access_id=urlParams.get('access_id') const $recent=document.querySelector('#webex-recent') const $space=document.querySelector('#webex-space') const $input=document.querySelector('#access_id_input') const setInputs=(selectors, vals)=>{selectors.forEach((selector, idx)=>{document.querySelector(selector, idx).value=vals[idx]})}const mountRecent=($, access_id, $space)=>{try{webex.widget($).remove()}catch(e){}webex.widget($).recentsWidget({accessToken: access_id,}); $.addEventListener('rooms:selected', (e)=>{const{id}=e.detail.data mountSpace($space, access_id, id) targetRoom=id console.log('#', targetRoom)})}const mountSpace=($, access_id, roomId)=>{try{webex.widget($).remove()}catch(e){}webex.widget($).spaceWidget({accessToken: access_id, destinationId: roomId, destinationType: 'spaceId',});}document.querySelector('#launch').addEventListener('click', (e)=>{const access_id=$input.value mountRecent($recent, access_id, $space)}) document.querySelector('#send_card').addEventListener('click', (e)=>{if (!targetRoom){alert('Select a room first') return}const form={card_title: document.querySelector('#card_title'), card_subtitle: document.querySelector('#card_subtitle'), image_url: document.querySelector('#image_url'), send_card: document.querySelector('#send_card')}const card={title: form.card_title.value, subtitle: form.card_subtitle.value, url: form.image_url.value}const cardData=generateCard(card) sendCard(targetRoom, cardData)}) if (access_id){mountRecent($recent, access_id, $space) setInputs(['#access_id_input'], [access_id])}async function sendCard(roomId, cardPayload, fallbackText="It appears your client cannot render adpative cards."){const access_id=$input.value const endpoint='https://webexapis.com/v1/messages' const card={roomId, markdown: fallbackText, attachments: [{contentType: "application/vnd.microsoft.card.adaptive", content: cardPayload}]}const response=await fetch(endpoint,{method: 'POST', headers:{'Content-Type': 'application/json', 'Authorization': 'Bearer ' + access_id}, body: JSON.stringify(card)}) const content=await response.json();}function generateCard({title, subtitle, url}){const card={type: "AdaptiveCard", version: "1.0", body: []}if (title){card.body.push({type: "TextBlock", text: title, size: "large", weight: "bolder", color: "dark"})}if (subtitle){card.body.push({type: "TextBlock", text: subtitle, size: "medium", weight: "bolder", color: "dark"})}if (image_url){card.body.push({type: "Image", url: url})}return card}</script></body>`,S=class{constructor(a,b=P){this.config=a,this.makeRequest=b,this.roomId="",this.fallbackText="Sorry, it appears your client does not support rendering Adaptive Cards, see here for more info: https://developer.webex.com/docs/api/guides/cards",this.token="",this.meta={url:""},this.locales={},this.API=C,a.locales&&(this.locales=a.locales),a.url&&(this.meta.url="/"===a.url.slice(-1)?a.url:`${a.url}/`),this.roomId=a.roomId,this.token=a.token,a.fallbackText&&(this.fallbackText=a.fallbackText)}pickRandom(a=[]){return A(a)}sendRandom(a=[]){return this.send(this.pickRandom(a))}fillTemplate(a,b){return _(a,b)}sendTemplate(a,b={}){let c=this.fillTemplate(a,b);return this.send(c)}async sendURL(a,c,d="Go"){let b=new x;c?b.setTitle(c).setUrl(a,d):b.setSubtitle(a).setUrl(a,d),this.send(b)}async api(a,b){let c=await fetch(a,b);try{return await c.json()}catch{return{}}}async dm(c,a,d){let b={text:this.fallbackText};if(k.isEmail(c)?b.toPersonEmail=c:b.toPersonId=c,"string"==typeof a&&(b.markdown=a,b.text=a),k.isCard(a)){d&&(b.text=d);let e=[{contentType:"application/vnd.microsoft.card.adaptive",content:"string"!=typeof a&&"render"in a&&"function"==typeof a.render?a.render():a},];b.attachments=e}return await this.makeRequest(this.API.sendMessage,b,{method:"POST","content-type":"application/json",token:this.token})}async send(a){let b={};return"string"==typeof a||("toPersonId"in a&&(b.toPersonId=a.toPersonId),"toPersonEmail"in a&&(b.toPersonEmail=a.toPersonEmail),"roomId"in a&&(b.roomId=this.roomId),"roomId"in a||"toPersonEmail"in a||"toPersonId"in a||(b.roomId=this.roomId)),"string"==typeof a?(b.roomId=this.roomId,b.markdown=a,b.text=a):"object"==typeof a&&(b=k.isCard(a)?{...b,markdown:this.fallbackText,text:this.fallbackText,attachments:[{contentType:"application/vnd.microsoft.card.adaptive",content:"render"in a&&"function"==typeof a.render?a.render():a},]}:{...b,...a}),await (await this.makeRequest(this.API.sendMessage,b,{method:"POST","content-type":"application/json",token:this.token})).json()}card(i={}){let a=new x,{title:b="",subTitle:c="",image:d="",url:e="",urlLabel:f="",data:g={},chips:h=[]}=i;return b&&a.setTitle(b),c&&a.setSubtitle(c),d&&a.setImage(d),e&&a.setUrl(e),f&&a.setUrlLabel(f),Object.keys(g).length&&a.setData(g),h.length&&a.setChips(h),a}async getSelf(){return await (await this.makeRequest(this.API.getSelf,{},{token:this.token,method:"GET"})).json()}async deleteMessage(a){return await this.makeRequest(`${this.API.deleteMessage}/${a}`,{},{token:this.token,method:"DELETE"})}async locationAuthorizer(a,e,b={yes:"\u2705 Allow",no:"\u274C Disallow"}){let{displayName:c}=await this.getSelf(),{id:d}=await this.send({parentId:a.message.id,text:`'${c}' needs to know your location in order to perform that action`}),f=`${this.meta.url}location?roomId=${a.message.roomId}&messageId=${d}`;this.send(this.card({title:e||`'${c}' wants to use your location, allow?`}).setUrl(f,b.yes).setData({messageId:d,action:"location_abort"}).setButtonLabel(b.no))}async getFile(e,f={}){let c=await this.makeRequest(e,{},{method:"GET",token:this.token}),b=c.headers.get("content-type"),d=c.headers.get("content-disposition").split(";")[1].split("=")[1].replace(/\"/g,""),g=d.split(".").pop()||"",h=!b.includes("json")&&!b.includes("txt")||b.includes("image"),a=c;if("arraybuffer"===f.responseType||h)try{a=await c.arrayBuffer()}catch{a={}}else a=await c.json();let i=`***No markdown preview available for ${b}***`;return{fileName:d,extension:g,type:b,data:a,markdownSnippet:"application/json"===b||"string"==typeof a&&a.length<900?this.snippet(a):i}}generateFileName(){let a=()=>`${Math.random().toString(36).slice(2)}`;return`${a()}_${a()}`}handleExtension(a=""){let c=a.indexOf(".")> -1,[b,d]=a.split(".");return c?b&&"*"!==b?a:`${this.generateFileName()}.${d}`:`${this.generateFileName()}.${b}`}async sendDataAsFile(a,d,h=null,i,l={}){if(!d)throw new Error('$(bot).sendDataAsFile: Missing filename/extension parameter, ex "myfile.png" or "*.png"');let b=h;if(!b&&!(b=this.guessContentType(d)))throw new Error("$(bot).sendDataAsFile: Missing 'content-type' parameter, ex \"image/png\"");let m=this.handleExtension(d),c=new FormData,{toPersonId:e=null,toPersonEmail:f=null}=l,n=e||f||this.roomId,o=a&&"object"==typeof a&&b.includes("json");c.append("files",new Blob([o?JSON.stringify(a,null,2):a],{type:b}),m),c.append(e?"toPersonId":f?"toPersonEmail":"roomId",n),c.append("text",i||this.fallbackText);let g=new Headers;return g.append("Authorization",`Bearer ${this.token}`),await fetch(C.sendMessage,{method:"POST",headers:g,body:c})}guessContentType(d){let e=d.indexOf(".")> -1,a="",b=d.split("."),f=b.length>2,[c,g]=b;return e?(c&&"*"!==c||(a=g),f&&(a=b.pop())):a=c,({doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",bmp:"image/bmp",gif:"image/gif",png:"image/png",txt:"text/plain",csv:"text/csv",html:"text/html",json:"application/json","*":"application/octet-stream",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",mpkg:"application/vnd.apple.installer+xml",vf:"application/json"})[a]||null}async thread(e){let[f,...d]=e,{id:g}=await this.send(f);for(let a=0;a<d.length;a++){let b=d[a],c={parentId:g};return"string"==typeof b&&(c.markdown=b,c.text=b),this.send(c)}}translate(c,d,a={},e=""){let f=this.locales[c]||{},b=this.lookUp(f,d,e);return Object.keys(a)?this.fillTemplate(b,a):b}sendDataFromUrl(a,b=" "){return this.send({files:[a],text:b})}log(...a){console.log.apply(console,a)}snippet(a,b="json"){return`
\`\`\`${b}
${"json"===b?JSON.stringify(a,null,2):a}
\`\`\``}async clearScreen(a=50){let b=`${`
`.repeat(a>7e3?5e3:a)}`;this.send({markdown:b,text:b})}async sendSnippet(b,c="",d="json",e){let a;return a="json"===d?this.snippet(b):this.snippet(b,"html"),c&&(a=c+` 
`+a),this.send({roomId:this.roomId,markdown:a,text:e||this.fallbackText})}makeLink(a){return`${this.meta.url}/${a}`}lookUp(a,b="",c){let d=a;return b.split(".").forEach(a=>{d=d?d[a]:c}),d||c}async say(a){return this.send(a)}async sendCard(a){return this.send(a)}};function D(a,b=P){return new S(a)}var R=class{constructor(a,b){if(this.config=a,this.handlers=b,this.globals={roomId:"",personId:"",fallbackText:"Sorry, it appears your client does not support rendering Adaptive Cards"},this.API={getMessageDetails:"https://webexapis.com/v1/messages",getAttachmentDetails:"https://webexapis.com/v1/attachment/actions",getMembershipDetails:"https://webexapis.com/v1/memberships",getPersonDetails:"https://webexapis.com/v1/people",sendMessage:"https://webexapis.com/v1/messages",createWebhook:"https://webexapis.com/v1/webhooks",deleteWebhook:"https://webexapis.com/v1/webhooks",getWebhooks:"https://webexapis.com/v1/webhooks",getSelf:"https://webexapis.com/v1/people/me",deleteMessage:"https://webexapis.com/v1/messages"},this.constants={catchall:"<@catchall>",submit:"<@submit>",file:"<@fileupload>",nomatch:"<@nomatch>",addbot:"<@botadded>",removebot:"<botremoved>",help:"<@help>",reqTypes:{TEXT:"TEXT",AA:"AA",FILE:"FILE",MEMBER_REMOVE:"MEMBERSHIP:REMOVE",MEMBER_ADD:"MEMBERSHIP:ADD"},errors:{placeholder:`ERROR: Placeholder token detected, you need to set a valid Bot Access token. 
If you need a token, see here: https://developer.webex.com/my-apps/new/bot`}},this._apiHeaders={headers:{Authorization:`Bearer ${this.config.token}`}},a.token===j){let c=this.constants.errors.placeholder;throw new Error(c)}}async processIncoming(d,g){if(this.debug("##",d),g&&this.config.validate&&"function"==typeof this.config.validate){let{validate:i}=this.config,{proceed:l}=await i(g);if(!l)return new Response("Request did not pass user-supplied validation",{status:400})}let a=B(d),e=await this.getEnhancedDetails(d,a),{personId:m,roomId:n,roomType:o}=d.data;this.globals.roomId=n;let f="group"===o&&e.text?e.text.split(" ").slice(1).join(" "):e.text&&e.text.toLowerCase()||null,p=await this.isHuman(m),r=!1;if(d.data&&(p||a&&"MEMBERSHIP:ADD"===a)){let b=[this.constants.catchall,this.constants.nomatch];if("AA"===a){let c=e;c.inputs&&c.inputs.chip_action?(this.config.features?.chips?.disappearOnTop&&await this.deleteMessage(c.messageId),a=this.constants.reqTypes.TEXT,f=c.inputs.chip_action.toLowerCase(),b.push(f)):c.inputs&&c.inputs.action?this.actionHandler(c):b=[this.constants.submit]}"FILE"===a&&b.push(this.constants.file),"MEMBERSHIP:ADD"===a&&(b=[this.constants.addbot]),"TEXT"===a&& -1===b.indexOf(f)&&b.push(f),this.debug("TARGETS",b);let s=await this.buildStash(b,this.handlers,a,f),t=a=>a&&"function"==typeof a.handler,h=null;b.forEach(async c=>{let b=s[c];if(c!==f||t(b)||(r=!0),c===this.constants.nomatch&&t(b)){h=b;return}t(b)&&this.invokeHandler(b,d,e,a,g)}),h&&r&&this.invokeHandler(h,d,e,a,g)}}async invokeHandler(a,b,c,d,e){await a.handler(D({token:this.config.token,roomId:this.globals.roomId,url:e.url,fallbackText:this.globals.fallbackText,locales:this.config.locales?this.config.locales:{}}),await this.buildTrigger(b,c,d))}async getPersonDetails(b){let a=await this.makeRequest(`${this.API.getPersonDetails}/${b}`,{},{method:"GET"});return a?await a.json():{}}async buildTrigger(l,b,e){let{personId:d}=b,f=await this.getPersonDetails(d);if("MEMBERSHIP:ADD"===e||"MEMBERSHIP:REMOVE"===e)return{type:"membership",id:b.id,message:b,personId:d,person:f};if("AA"===e)return{id:b.id,attachmentAction:b,personId:d,person:f};{let a=b,g="group"===l.data.roomType&&a.text?a.text.split(" ").slice(1).join(" "):a.text&&a.text.toLowerCase()||null;if(!a.text&&"inputs"in b){let{chip_action:h}=b.inputs;g!=h&&(g=h)}let c={type:"message",id:a.id,message:a,args:a.text?a.text.split(" "):[],personId:d,person:f,text:g};if("group"===a.roomType&&c.args.length){let i=c.args.slice(1);c.args=i,c.text=i.join(" "),c.message.text=c.text}return c}}async buildStash(b,a,d,e){let c=b.reduce((a,b)=>(a[b]=null,a),{});if(Array.isArray(a)){let f=(a,b)=>{let d="string"==typeof a?a.toLowerCase():"";d in c?c[d]=b:a instanceof RegExp&&a.test(e)&&(c[e]=b)};a.forEach(b=>{let{keyword:a}=b;"string"==typeof a||a instanceof RegExp?f(a,b):Array.isArray(a)&&a.forEach(a=>{f(a,b)})})}else"object"==typeof a&&b.forEach(b=>{a[b]&&(c[b]=a[b])});return c}async _send(a){return await (await (async(e,b,a={})=>{let c={method:"POST","content-type":"application/json;charset=UTF-8",raw:!1},f=a["content-type"]?a["content-type"]:c["content-type"],g=a.headers?a.headers:{},d={method:a.method?a.method:c.method,headers:{"content-type":f,Authorization:`Bearer ${this.globals?.config?.token}`,...g}};return"POST"===a.method&&(d.body=a.raw?b:JSON.stringify(b)),await fetch(e,d)})(this.API.sendMessage,a)).json()}async send(a){let b={roomId:this.globals.roomId};return"object"==typeof a&&"roomId"in a&&(b.roomId=a.roomId),"string"==typeof a?(b.markdown=a,b.text=a):"object"==typeof a&&(b=k.isCard(a)?{...b,markdown:this.globals.fallbackText,text:this.globals.fallbackText,attachments:[{contentType:"application/vnd.microsoft.card.adaptive",content:"render"in a&&"function"==typeof a.render?a.render():a},]}:{...b,...a}),await (await (async(e,b,a={})=>{let c={method:"POST","content-type":"application/json;charset=UTF-8",raw:!1},f=a["content-type"]?a["content-type"]:c["content-type"],g=a.headers?a.headers:{},d={method:a.method?a.method:c.method,headers:{"content-type":f,Authorization:`Bearer ${a.token}`,...g}};return"POST"===a.method&&(d.body=a.raw?b:JSON.stringify(b)),await fetch(e,d)})(this.API.sendMessage,b,{method:"POST","content-type":"application/json",token:this.config.token})).json()}async deleteMessage(a){return await this.makeRequest(`${this.API.deleteMessage}/${a}`,{},{method:"DELETE"})}async delay(a=100){return new Promise(b=>setTimeout(b,a))}async isHuman(b,c=!1){let a=await this.getSelf(),{id:d}=a;return c?a:d!==b}async getSelf(){return await (await this.makeRequest(this.API.getSelf,{},{method:"GET"})).json()}async makeRequest(e,b,a={}){let c={method:"POST","content-type":"application/json;charset=UTF-8",raw:!1},f=a["content-type"]?a["content-type"]:c["content-type"],g=a.headers?a.headers:{},d={method:a.method?a.method:c.method,headers:{"content-type":f,Authorization:`Bearer ${this.config.token}`,...g}};"POST"===a.method&&(d.body=a.raw?b:JSON.stringify(b));try{return await fetch(e,d)}catch(h){console.log("ERR#",h)}}async getEnhancedDetails(c,b){let a=this.API.getMessageDetails;"AA"===b&&(a=this.API.getAttachmentDetails),("MEMBERSHIP:REMOVE"===b||"MEMBERSHIP:ADD"===b)&&(a=this.API.getMembershipDetails);let{data:d}=c,{id:e}=d;return await (await this.makeRequest(a=`${a}/${e}`,{},{method:"GET"})).json()}debug(...a){this.config.debug&&console.log.apply(console,a)}async actionHandler(a){let{action:b=""}=a.inputs;if("location_abort"===b){let{messageId:c}=a;await this.deleteMessage(c);let{messageId:d}=a.inputs;await this.deleteMessage(d)}if("delete_message"===b){let{messageId:e}=a.inputs;await this.deleteMessage(e)}}},N={city:"error",colo:"error",continent:"error",latitude:"error",longitude:"error",country:"error",postalCode:"error",region:"error",state:"error",tod:"error",timezone:"error"},U=e=>{let{city:f="error",colo:g="error",continent:h="error",country:i="error",latitude:l="error",longitude:m="error",postalCode:n="error",region:c="error",timezone:d="error"}=e,b="error";try{let o=new Date().toLocaleString("en-US",{timeZone:d}),a=new Date(o).getHours();(20<=a||a<=3)&&(b="evening"),a<=11&&(b="morning"),12<=a&&a<=16&&(b="afternoon"),17<=a&&a<=19&&(b="evening")}catch{b="error"}return{city:f,colo:g,continent:h,country:i,latitude:l,longitude:m,postalCode:n,region:c,state:c,tod:b,timezone:d}},I=class extends S{constructor(a,b){super(a),this.location=N,this.location=U(b)}},ue={async fetch(a,b,c){let d={locales:{de:{greetings:{welcome:"[german] hi tharr!"}}},validate:async a=>({proceed:!0}),async location(a){a.send(a.card({title:`Good ${a.location.tod}`,subTitle:"Note this data is not stored/collected/sold and is not hyper-accurate. Good enough to understand if its dark/light outside whenever a user is located"}).setTable([["Country",a.location.country],["City",a.location.city],["Region",a.location.region],["Timezone",a.location.timezone],]).setUrl(`https://maps.google.com/?q=${a.location.latitude},${a.location.longitude}`,"See map \u{1F5FA}"))},debug:!0,fallbackText:"Sorry, it does not appear your client supports rendering cards",token:config.token};return L({"/whoami":{handler(b,o,p){let{cf:c}=b,{city:d,colo:e,continent:f,country:g,latitude:h,longitude:i,postalCode:l,region:m,timezone:n}=c||{},a=()=>`${Math.random().toString(36).slice(2)}`;return new Response(JSON.stringify({rando:`${a()}_${a()}`,city:d,colo:e,continent:f,country:g,latitude:h,longitude:i,postalCode:l,region:m,timezone:n}),{status:200,headers:{"content-type":"application/json"}})}},"/intercept":{method:"GET",handler(b,e,c){let{searchParams:d}=new URL(b.url),a=d.get("target")||null;return a?(c.waitUntil(new Promise(n=>{let{cf:a}=b,{city:c,colo:d,continent:e,country:f,latitude:g,longitude:h,postalCode:i,region:l,timezone:m}=a||{};console.log("# Analytics-ize this somehow...",c,d,e,f,g,h,i,l,m)})),Response.redirect(a)):new Response("No target specified")}},"/healthcheck":{method:"GET",handler:a=>O(`<html><h1 style="color:${((a=[])=>a[Math.floor(Math.random()*a.length)])(["#e74c3c","#e67e22","#16a085","#2980b9","#8e44ad","#2c3e50",])};">${a.url}</h1></html>`)},"/":{method:"POST",handler:async(b,c,a)=>(a.waitUntil(new Promise(async(g,c)=>{let e=new R(d,handlers);try{let f=await b.json();await e.processIncoming(f,b)}catch(a){return c(a),new Response(`Something happened, but backend is up and running: ${a}`)}})),w())},"/ui":a=>new Response(q,{status:200,headers:{"content-type":"text/html;charset=UTF-8"}}),async "/location"(a,v,f){let{cf:g}=a,{city:h,colo:i,continent:l,country:m,latitude:n,longitude:o,postalCode:p,region:r,timezone:s}=g||{},{searchParams:e}=new URL(a.url),b=e.get("roomId")||null,c=e.get("messageId")||null;if(!b||!c)return new Response("Missing parameters",{status:422});if(!b||!c)return w();{let $={city:h,colo:i,continent:l,country:m,latitude:n,longitude:o,postalCode:p,region:r,timezone:s},t={token:d.token,roomId:b,meta:{url:a.url}},u=new I(t,$);if(404===(await u.deleteMessage(c)).status)return new Response("Sorry, that link is no longer valid",{status:401});if("location"in d&&"function"==typeof d.location){let y=d.location;f.waitUntil(new Promise(async a=>{"location"in d&&y(u)}))}return new Response("Ok")}},"/biscotti":(a,b,c)=>Response.redirect("https://www.youtube.com/watch?v=6A8W77m-ZTw&t=102s")},a,b,c)}};export{D as InitBot,ue as default}
